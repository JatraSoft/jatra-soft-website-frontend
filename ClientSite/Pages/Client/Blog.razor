@page "/blog"
@using ClientSite.Models
@using Microsoft.AspNetCore.Components
@using System.Linq
@inject IBlogService BlogService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<style>
    /* ===== Hero ===== */
    .base-main-title {
        font-size: 2.25rem;
        font-weight: 700;
    }

    .base-text {
        color: #495057;
        font-size: 1rem;
    }

    /* ===== Search & Category ===== */
    .blog-search-box {
        border-radius: 50px;
        overflow: hidden;
    }

    .blog-search-input {
        border: none;
        padding: 0.55rem 1rem;
        border-radius: 50px 0 0 50px;
        box-shadow: none;
        outline: none;
        transition: all 0.3s;
    }

        .blog-search-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(60, 185, 224, 0.3);
        }

    .blog-search-btn {
        background: #3CB9E0;
        color: #fff;
        border: none;
        padding: 0.55rem 0.9rem;
        border-radius: 0 50px 50px 0;
        transition: background 0.3s, transform 0.2s;
    }

        .blog-search-btn:hover {
            background: #34a1c1;
            transform: translateY(-2px);
        }

    .blog-category-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .blog-category-btn {
        background: #3CB9E0;
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 0.45rem 1rem;
        font-weight: 600;
        transition: all 0.3s;
    }

        .blog-category-btn:hover {
            background: #34a1c1;
            transform: translateY(-2px);
        }

        .blog-category-btn.active {
            background: #001829;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

    /* ===== Featured Posts ===== */
    .featured-blog-card .card-body {
        background: linear-gradient(135deg, #001829, #00324d);
        color: #fff;
        min-height: 160px;
    }

    .featured-badge {
        position: absolute;
        right: 12px;
        top: 12px;
        background: rgba(255,255,255,0.12);
        color: #fff;
        padding: 0.2rem 0.45rem;
        border-radius: 0.25rem;
        font-weight: 600;
        backdrop-filter: blur(2px);
    }

    /* ===== Blog Cards ===== */
    .blog-card {
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
    }

        .blog-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.15);
        }

        .blog-card img {
            transition: transform 0.3s;
        }

        .blog-card:hover img {
            transform: scale(1.05);
        }

    /* Overlay for hover */
    .blog-card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 220px;
        background: rgba(0, 0, 0, 0.45);
        opacity: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.3s;
    }

    .blog-card:hover .blog-card-overlay {
        opacity: 1;
    }

    .blog-btn-overlay {
        background: none;
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s;
    }

        .blog-btn-overlay:hover {
            transform: translateY(-2px);
        }

    /* Tags */
    .badge-blog-tag {
        background: #3CB9E0;
        color: #000;
        font-weight: 600;
        border-radius: 0.35rem;
        padding: 0.25rem 0.45rem;
        font-size: 0.72rem;
        display: inline-block;
        margin-right: 0.35rem;
        margin-bottom: 0.35rem;
    }

    .card-tags {
        margin: 0.45rem 0 0.75rem 0;
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    /* Text truncate */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* ===== Modal ===== */
    .blog-modal-body {
        line-height: 1.75;
        font-size: 1rem;
        color: #21343a;
    }

    .modal-backdrop.show {
        opacity: 0.6 !important;
    }
</style>

<section class="py-5 bg-light">
    <div class="container">
        <!-- Hero Section -->
        <div class="text-center mb-4">
            <h2 class="base-main-title">Our Blog</h2>
            <p class="base-text mx-auto">Explore the latest articles, insights, and tips about technology, business, and digital innovation.</p>
        </div>
        @if(ShowHeroAndFeatured)
        {
            <!-- Search & Categories -->
            <div class="row mb-4">
                <div class="col-md-6 mb-2">
                    <div class="input-group blog-search-box">
                        <input class="form-control blog-search-input" placeholder="Search posts..." @bind="searchQuery" @bind:event="oninput" />
                        <button class="blog-search-btn" @onclick="OnSearch" disabled="@loading">
                            <i class="bi bi-search"></i>
                        </button>
                        <button class="blog-search-btn" @onclick="ClearSearch" disabled="@loading">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-6 text-md-end">
                    <div class="blog-category-group">
                        <button class="blog-category-btn @(selectedCategory == null ? "active" : "")" @onclick="() => FilterByCategory(null)">All</button>
                        @foreach (var cat in categories)
                        {
                            <button class="blog-category-btn @(selectedCategory == cat ? "active" : "")" @onclick="() => FilterByCategory(cat)">@cat</button>
                        }
                    </div>
                </div>
            </div>

            <!-- Featured Posts -->
            @if (posts != null && posts.Any(p => p.IsFeatured))
            {
                <div class="mb-5">
                    <h4 class="mb-3">Featured Posts</h4>
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        @foreach (var post in posts.Where(p => p.IsFeatured).OrderByDescending(p => p.CreatedAt).Take(2))
                        {
                            <div class="col position-relative">
                                <article class="card h-100 shadow-sm overflow-hidden featured-blog-card">
                                    <div style="height:250px; overflow:hidden; position:relative;">
                                        <img src="@(post.ImageUrl ?? "https://via.placeholder.com/800x400")"
                                             class="card-img-top w-100" alt="@post.Title" style="object-fit:cover; height:100%;" />
                                        <div class="featured-badge">FEATURED</div>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">@post.Title</h5>
                                        @if (!string.IsNullOrWhiteSpace(post.Tags))
                                        {
                                            <div class="card-tags">
                                                @foreach (var tag in post.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                                                {
                                                    <span class="badge-blog-tag">@tag</span>
                                                }
                                            </div>
                                        }
                                        <p class="card-text text-light mb-3 text-truncate">@post.ShortDescription</p>
                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                            <small class="text-light">@post.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</small>
                                            <button class="btn btn-light btn-sm" @onclick="() => ShowPost(post)">Read More</button>
                                        </div>
                                    </div>
                                </article>
                            </div>
                        }
                    </div>
                </div>
            }
        }
        
        <!-- Blog Grid -->
        @if (loading)
        {
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        }
        else if (posts == null || !posts.Any())
        {
            <p class="text-center">No posts found.</p>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var post in posts.OrderByDescending(p => p.CreatedAt))
                {
                    <div class="col">
                        <article class="card h-100 shadow-sm blog-card position-relative" @onclick="() => ShowPost(post)">
                            <div style="height:220px; overflow:hidden;">
                                <img src="@(post.ImageUrl ?? "https://via.placeholder.com/800x400")"
                                     class="card-img-top w-100" alt="@post.Title" style="object-fit:cover; height:100%;" />
                            </div>

                            <div class="blog-card-overlay d-flex justify-content-center align-items-center">
                                <button class="blog-btn-overlay">Read</button>
                            </div>

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">@post.Title</h5>
                                @if (!string.IsNullOrWhiteSpace(post.Tags))
                                {
                                    <div class="card-tags">
                                        @foreach (var tag in post.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                                        {
                                            <span class="badge-blog-tag">@tag</span>
                                        }
                                    </div>
                                }
                                <p class="card-text text-muted mb-2 text-truncate-2">@post.ShortDescription</p>
                                <div class="mt-auto d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><i class="bi bi-calendar-event"></i> @post.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</small>
                                    <small class="text-muted">⏱ @post.ReadTimeMinutes min</small>
                                </div>
                            </div>
                        </article>
                    </div>
                }
            </div>
        }
    </div>
</section>

<!-- Modal -->
@if (selectedPost != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.6);" tabindex="-1" role="dialog" aria-modal="true" @onclick="CloseModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" @onclick:stopPropagation>
            <div class="modal-content rounded-4 shadow-lg">
                <div class="modal-header border-0">
                    <div class="d-flex align-items-center gap-3">
                        <img src="@(selectedPost.AuthorImageUrl ?? "https://via.placeholder.com/48")" alt="@selectedPost.AuthorName" class="rounded-circle" style="width:48px; height:48px; object-fit:cover;" />
                        <div>
                            <h5 class="modal-title mb-0">@selectedPost.Title</h5>
                            <small class="text-muted">@selectedPost.AuthorName • @selectedPost.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy") • @selectedPost.ReadTimeMinutes min</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body blog-modal-body">
                    @if (!string.IsNullOrEmpty(selectedPost.ImageUrl))
                    {
                        <img src="@selectedPost.ImageUrl" class="img-fluid rounded mb-3" style="object-fit:cover; width:100%; max-height:420px;" />
                    }

                    @if (!string.IsNullOrEmpty(selectedPost.LongDescription))
                    {
                        @((MarkupString)selectedPost.LongDescription)
                    }
                    else
                    {
                        <p class="text-muted">No content available.</p>
                    }

                    @if (!string.IsNullOrEmpty(selectedPost.Tags))
                    {
                        <div class="mt-3">
                            @foreach (var tag in selectedPost.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                            {
                                <span class="badge-blog-tag me-1">@tag</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter]
    public bool ShowHeroAndFeatured { get; set; } = true;

    private List<BlogPost>? posts;
    private BlogPost? selectedPost;
    private List<string> categories = new();
    private string? selectedCategory;
    private string? searchQuery;
    private bool loading = true;
    private CancellationTokenSource? searchCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        loading = true;
        try
        {
            posts = await BlogService.GetAllBlogsAsync() ?? new List<BlogPost>();
            BuildCategoryList();
        }
        catch (Exception ex)
        {
            posts = new List<BlogPost>();
            await JSRuntime.InvokeVoidAsync("console.error", "Failed to load blog posts: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void BuildCategoryList()
    {
        categories = posts?
            .Where(p => !string.IsNullOrWhiteSpace(p.Category))
            .Select(p => p.Category!.Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(c => c)
            .ToList() ?? new List<string>();
    }

    private async Task OnSearch()
    {
        searchCts?.Cancel();
        searchCts = new CancellationTokenSource();

        var query = searchQuery?.Trim();
        if (string.IsNullOrEmpty(query))
        {
            if (string.IsNullOrEmpty(selectedCategory))
            {
                await LoadPosts();
                return;
            }
            else
            {
                await FilterByCategory(selectedCategory);
                return;
            }
        }

        try
        {
            loading = true;
            posts = await BlogService.SearchBlogsAsync(query) ?? new List<BlogPost>();
            BuildCategoryList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.ToString());
            posts = new List<BlogPost>();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task FilterByCategory(string? category)
    {
        selectedCategory = category;
        searchQuery = null;

        loading = true;
        try
        {
            if (string.IsNullOrEmpty(category))
            {
                await LoadPosts();
            }
            else
            {
                posts = await BlogService.GetBlogsByCategoryAsync(category) ?? new List<BlogPost>();
                BuildCategoryList();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.ToString());
            posts = new List<BlogPost>();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void ShowPost(BlogPost post)
    {
        selectedPost = post;
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedPost = null;
    }

    // Keep Copy/Open helpers (unused in modal) for future use or share buttons elsewhere.
    private async Task CopyPostLink(BlogPost post)
    {
        try
        {
            var baseUri = NavigationManager.BaseUri.TrimEnd('/');
            var permalink = !string.IsNullOrWhiteSpace(post.Slug)
                ? $"{baseUri}/blog/{Uri.EscapeDataString(post.Slug)}"
                : $"{NavigationManager.Uri}#post-{post.Id}";

            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", permalink);
            await JSRuntime.InvokeVoidAsync("alert", "Link copied to clipboard.");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("prompt", "Copy this link:", NavigationManager.Uri);
        }
    }

    private Task OpenInNewTab()
    {
        if (selectedPost == null) return Task.CompletedTask;

        var baseUri = NavigationManager.BaseUri.TrimEnd('/');
        var url = !string.IsNullOrWhiteSpace(selectedPost.Slug)
            ? $"{baseUri}/blog/{Uri.EscapeDataString(selectedPost.Slug)}"
            : $"{NavigationManager.Uri}#post-{selectedPost.Id}";

        return JSRuntime.InvokeVoidAsync("open", url, "_blank").AsTask();
    }

    // Clears search and reloads posts (respects selected category)
    private async Task ClearSearch()
    {
        if (string.IsNullOrEmpty(searchQuery)) return;

        searchQuery = null;

        if (!string.IsNullOrEmpty(selectedCategory))
            await FilterByCategory(selectedCategory);
        else
            await LoadPosts();

        StateHasChanged();
    }
}